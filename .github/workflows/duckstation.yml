name: DuckStation UWP Builder

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag Name'
        required: true
        default: 'v1.0.0'
      package_name:
        description: 'Package Name'
        required: true
        default: 'DuckStation-UWP'

jobs:
  build:
    runs-on: windows-2022

    env:
      SolutionPath: duckstation.sln
      Platform: x64
      Configuration: ReleaseUWP
      BuildMode: SideLoadOnly
      AppxBundle: Never
      ProjectPath: src/duckstation-uwp
      ProjectDirectory: src/duckstation-uwp
      PackageOutputRootDir: C:\AppPackage
      PackageOutputDir: DuckStation

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          ref: refs/heads/uwp
          submodules: true

      - name: Checkout Specific Commit
        run: git checkout e080c27
        shell: pwsh

      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: Install wget and 7zip
        run: |
          choco install wget -y
          choco install 7zip -y
        shell: pwsh

      - name: Download and Extract Dependencies Pack
        run: |
          wget https://github.com/stenzek/duckstation-ext-qt-minimal/releases/download/latest/deps-x64.7z
          7z x deps-x64.7z -odep/msvc
        shell: pwsh

      - name: Display Environment Variables
        run: |
          echo "SolutionPath: $env:SolutionPath"
          echo "Platform: $env:Platform"
          echo "Configuration: $env:Configuration"
          echo "BuildMode: $env:BuildMode"
          echo "AppxBundle: $env:AppxBundle"
          echo "ProjectPath: $env:ProjectPath"
          echo "ProjectDirectory: $env:ProjectDirectory"
          echo "PackageOutputRootDir: $env:PackageOutputRootDir"
          echo "PackageOutputDir: $env:PackageOutputDir"
        shell: pwsh

      - name: Generate Self-Signed Certificate
        id: generate_cert
        run: |
          $cert = New-SelfSignedCertificate -CertStoreLocation "Cert:\CurrentUser\My" -Subject "CN=MyUWPCert" -KeyAlgorithm RSA -KeyLength 2048 -Provider "Microsoft Enhanced RSA and AES Cryptographic Provider" -KeyExportPolicy Exportable -NotAfter (Get-Date).AddYears(1) -Type CodeSigningCert
          echo "THUMBPRINT=$($cert.Thumbprint)" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Set Package Name
        id: set_package_name
        run: |
          echo "PACKAGE_NAME=${{ github.event.inputs.package_name }}_${{ github.event.inputs.tag_name }}" >> $GITHUB_ENV

      - name: Restore NuGet Packages
        run: |
          msbuild $env:SolutionPath /t:restore /p:Configuration=$env:Configuration /p:Platform=$env:Platform /p:PlatformToolset=v143
        shell: pwsh

      - name: App Build
        run: |
          msbuild $env:SolutionPath `
            /p:Platform=$env:Platform `
            /p:Configuration=$env:Configuration `
            /p:PlatformToolset=v143 `
            /p:UapAppxPackageBuildMode=$env:BuildMode `
            /p:AppxBundle=$env:AppxBundle `
            /p:PackageCertificateThumbprint="${{ env.THUMBPRINT }}" `
            /p:AppxPackageTestDir="${{ env.PackageOutputRootDir }}\${{ env.PACKAGE_NAME }}"
        shell: pwsh
